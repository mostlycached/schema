# Audiobook Production Workflow

This document outlines the automated pipeline for generating the "Invisible Rooms" audiobook.

## 1. Configuration
*   **Source Text**: `book/*.md` (Rewritten in "Room" style).
*   **Scripts**: `book/scripts/*.txt` (Generated by `generate_full_scripts.py`).
*   **Audio Config**: `book/audiobook_config.json` (Defines prompts and file mapping).

## 2. The Pipeline Script
The entire process is orchestrated by `book/produce_audiobook.py`.

### Step 1: Clean Up
The script removes stale `chapter_*.mp3` speech files to ensure new text edits are reflected.

### Step 2: Speech Generation (`generate_audio_batch.py`)
*   **API**: ElevenLabs Text-to-Speech (`eleven_turbo_v2_5`).
*   **Voice**: "JBFqnCBsd6RMkjVDRZzb" (Deep, neutral narrator).
*   **Input**: `book/scripts/*.txt`.
*   **Output**: `book/chapter_XX.mp3`.

### Step 3: Music Generation (`generate_music_batch.py`)
*   **API**: ElevenLabs Music (`eleven_v2`).
*   **Input**: Prompts from `audiobook_config.json`.
*   **Duration**: 135 seconds (fixed).
*   **Output**: `book/chapter_XX_music.mp3`.
*   *Note*: Skips generation if a file >1MB already exists to save credits.

### Step 4: Merging (`merge_audio.py`)
*   **Tool**: `ffmpeg` (via `subprocess`).
*   **Logic**:
    1.  Input 1: Music.
    2.  Input 2: Speech.
    3.  Input 3: Silence (3 seconds, generated via `lavfi`).
    4.  Concatenate: `[Music] -> [Speech] -> [Silence]`.
*   **Output**: `book/Chapter XX - Title.mp3`.

### Step 5: Generate .wav files from .mp3 files
*   **Tool**: `ffmpeg` (via `subprocess`).
*   **Logic**: Convert `book/Chapter XX - Title.mp3` to `book/Chapter XX - Title.wav`.
*   **Format**: 24-bit PCM, 48 kHz sample rate, stereo (2117 kbps).
*   **Command**: `ffmpeg -i input.mp3 -acodec pcm_s24le -ar 48000 output.wav`
*   **Output**: `book/Chapter XX - Title.wav`.

### Step 6: Cover Art
*   **Prompting**: Create a "subtle, constraint-driven" visual. 
    *   *Avoid*: Text in image, overly busy collages.
    *   *Prefer*: Single subtle variation, "glitch in the matrix" style, minimalist architectural photography.
*   **Resolution**: Must be at least 1400x1400px (standard audiobook requirement).
*   **Tools**:
    *   Generate: DALL-E 3 / Imagen.
    *   Upscale: Use `sips -Z 1400 cover.png` (macOS) or ffmpeg.


## 3. How to Run
```bash
python3 book/produce_audiobook.py
```

## 4. Dependencies
*   `ffmpeg` (System requirement)
*   `requests`, `python-dotenv` (Python)
*   `ELEVENLABS_API_KEY` in `.env`
